rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow write: if false;
      allow read: if false;
    }



    ///////////////////////
    // Utility functions //
    ///////////////////////

    function isAuthenticated() {
        return request.auth != null;
    }



    /////////////////
    // Role system //
    /////////////////

    function userHasRole(role, uid) {
        return isAuthenticated()
            && exists(/databases/$(database)/documents/roles/$(role)/uids/$(uid));
    }

    match /roles/{roleName}/uids/{uid} {
      allow write: if false;
      allow read: if isAuthenticated()
    }

    // Role: leader
    match /roles/leader/uids/{uid} {
      allow write: if false;
    }

    // Role: member
    match /roles/member/uids/{uid} {
      allow write: if userHasRole("leader");
    }
  }
}
